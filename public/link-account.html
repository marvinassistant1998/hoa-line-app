<!DOCTYPE html>
<html>
<head>
  <title>ç¶å®šä¸»å§” LINE å¸³è™Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: -apple-system, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
    button { background: #06C755; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; cursor: pointer; width: 100%; margin: 8px 0; }
    button:disabled { background: #ccc; }
    .card { background: #f5f5f7; border-radius: 12px; padding: 16px; margin: 12px 0; }
    .label { color: #86868b; font-size: 13px; }
    .value { color: #1d1d1f; font-weight: bold; font-size: 15px; margin-top: 4px; }
    #log { background: #1D1D1F; color: #34C759; padding: 16px; border-radius: 8px; font-family: monospace; font-size: 13px; white-space: pre-wrap; max-height: 300px; overflow-y: auto; margin-top: 16px; }
    select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #e8e8ed; font-size: 15px; margin: 8px 0; }
  </style>
</head>
<body>
  <h1>ğŸ”— ç¶å®š LINE å¸³è™Ÿåˆ°ä½æˆ¶</h1>
  <p>é€™å€‹å·¥å…·æœƒå°‡ä½ çš„ LINE userId å¯«å…¥ Firestore ä½æˆ¶è³‡æ–™ä¸­</p>

  <div class="card">
    <div class="label">ä½ çš„ LINE userId</div>
    <div class="value" id="userId">è®€å–ä¸­...</div>
  </div>

  <div class="card">
    <div class="label">ä½ çš„ LINE åç¨±</div>
    <div class="value" id="displayName">è®€å–ä¸­...</div>
  </div>

  <div class="card">
    <div class="label">é¸æ“‡è¦ç¶å®šçš„ä½æˆ¶</div>
    <select id="residentSelect">
      <option value="">è¼‰å…¥ä¸­...</option>
    </select>
  </div>

  <button id="linkBtn" disabled>ç¶å®šå¸³è™Ÿ</button>

  <div id="log" style="display:none;"></div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
    var LIFF_ID = '2009004300-wqzTZcHc';
    var firebaseConfig = {
      apiKey: "AIzaSyBWm5rKT3535klcNVtWCK6oosdr2BO-ZrQ",
      authDomain: "hoa-line-app-3e2f1.firebaseapp.com",
      projectId: "hoa-line-app-3e2f1",
      storageBucket: "hoa-line-app-3e2f1.firebasestorage.app",
      messagingSenderId: "225045051582",
      appId: "1:225045051582:web:9235d2cddff542456786ef",
    };

    firebase.initializeApp(firebaseConfig);
    var db = firebase.firestore();
    var userProfile = null;
    var allResidents = [];

    function log(msg) {
      var el = document.getElementById('log');
      el.style.display = 'block';
      el.textContent += msg + '\n';
    }

    async function init() {
      try {
        // åˆå§‹åŒ– LIFF
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        userProfile = await liff.getProfile();
        document.getElementById('userId').textContent = userProfile.userId;
        document.getElementById('displayName').textContent = userProfile.displayName;

        // è®€å– Firestore ä½æˆ¶åˆ—è¡¨
        var snapshot = await db.collection('residents').get();
        var select = document.getElementById('residentSelect');
        select.innerHTML = '<option value="">-- è«‹é¸æ“‡ä½æˆ¶ --</option>';

        snapshot.forEach(function(doc) {
          var data = doc.data();
          allResidents.push({ id: doc.id, ...data });
          var opt = document.createElement('option');
          opt.value = doc.id;
          var linked = data.lineUserId ? ' âœ… å·²ç¶å®š' : '';
          opt.textContent = data.name + ' (' + data.unit + ') - ' + data.role + linked;
          select.appendChild(opt);
        });

        document.getElementById('linkBtn').disabled = false;
      } catch (err) {
        document.getElementById('userId').textContent = 'ç„¡æ³•è®€å–ï¼ˆè«‹å¾ LINE é–‹å•Ÿæ­¤é é¢ï¼‰';
        document.getElementById('displayName').textContent = err.message;
        log('éŒ¯èª¤: ' + err.message);

        // å³ä½¿ LIFF å¤±æ•—ï¼Œä¹Ÿè¼‰å…¥ä½æˆ¶åˆ—è¡¨
        try {
          var snapshot = await db.collection('residents').get();
          var select = document.getElementById('residentSelect');
          select.innerHTML = '<option value="">-- è«‹é¸æ“‡ä½æˆ¶ --</option>';
          snapshot.forEach(function(doc) {
            var data = doc.data();
            allResidents.push({ id: doc.id, ...data });
            var opt = document.createElement('option');
            opt.value = doc.id;
            var linked = data.lineUserId ? ' âœ… å·²ç¶å®š: ' + data.lineUserId.substring(0, 10) + '...' : ' âŒ æœªç¶å®š';
            opt.textContent = data.name + ' (' + data.unit + ') - ' + data.role + linked;
            select.appendChild(opt);
          });
        } catch (e) {
          log('ç„¡æ³•è®€å–ä½æˆ¶: ' + e.message);
        }
      }
    }

    document.getElementById('linkBtn').addEventListener('click', async function() {
      var btn = document.getElementById('linkBtn');
      var select = document.getElementById('residentSelect');
      var docId = select.value;

      if (!docId) {
        alert('è«‹å…ˆé¸æ“‡ä¸€ä½ä½æˆ¶');
        return;
      }

      if (!userProfile) {
        alert('è«‹å¾ LINE é–‹å•Ÿæ­¤é é¢ä»¥å–å¾—ä½ çš„ LINE userId');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'ç¶å®šä¸­...';

      try {
        await db.collection('residents').doc(docId).update({
          lineUserId: userProfile.userId,
        });

        var resident = allResidents.find(function(r) { return r.id === docId; });
        log('âœ… æˆåŠŸï¼å·²å°‡ ' + userProfile.displayName + ' çš„ LINE userId ç¶å®šåˆ° ' + (resident ? resident.name : docId));
        log('LINE userId: ' + userProfile.userId);
        log('\nç¾åœ¨é‡æ–°æ‰“é–‹ appï¼Œå°±æœƒè‡ªå‹•åµæ¸¬åˆ°ä½ çš„è§’è‰²äº†ï¼');

        btn.textContent = 'âœ… ç¶å®šæˆåŠŸï¼';
      } catch (err) {
        log('âŒ ç¶å®šå¤±æ•—: ' + err.message);
        btn.textContent = 'é‡è©¦';
        btn.disabled = false;
      }
    });

    init();
  </script>
</body>
</html>
